<p>A GraphQL system exposes your application to the world according to its <em>schema</em>. A schema includes:</p>

<ul>
  <li><em>Types</em> which expose objects in your application</li>
  <li><em>Fields</em> which expose properties of those objects (and may connect types to other types)</li>
  <li><em>Query root</em>, which is a special type used for executing read queries</li>
  <li><em>Mutation root</em>, which is a special type used for executing mutations</li>
</ul>

<p>Once you’ve defined your query root and mutation root, you can make a schema:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">ApplicationSchema</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">query</span> <span class="no">QueryRoot</span>
  <span class="n">mutation</span> <span class="no">MutationRoot</span>
<span class="k">end</span>
</code></pre>
</div>

<p>At that time, <code class="highlighter-rouge">graphql-ruby</code> will validate all types and fields.</p>

<h2 id="getting-started-with-types">Getting Started with Types</h2>

<p>Create types to wrap objects &amp; expose data through fields.</p>

<p>Let’s imagine we have a blog with only a <code class="highlighter-rouge">Post</code> model (no comments yet :) :</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Post</span>
  <span class="kp">attr_accessor</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="c1"># get a Post from the database</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Let’s make type for <code class="highlighter-rouge">Post</code>:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># `types` is a helper for declaring GraphQL types</span>
<span class="no">PostType</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">ObjectType</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="nb">name</span> <span class="s2">"Post"</span>
  <span class="n">description</span> <span class="s2">"A blog entry"</span>

  <span class="n">field</span> <span class="ss">:id</span><span class="p">,</span> <span class="o">!</span><span class="n">types</span><span class="o">.</span><span class="no">ID</span><span class="p">,</span> <span class="s2">"The unique ID for this post"</span>
  <span class="n">field</span> <span class="ss">:title</span><span class="p">,</span> <span class="o">!</span><span class="n">types</span><span class="o">.</span><span class="no">String</span><span class="p">,</span> <span class="s2">"The title of this post"</span>
  <span class="n">field</span> <span class="ss">:body</span><span class="p">,</span> <span class="o">!</span><span class="n">types</span><span class="o">.</span><span class="no">String</span><span class="p">,</span>  <span class="s2">"The body of this post"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Now, posts will expose <code class="highlighter-rouge">id</code>, <code class="highlighter-rouge">title</code> and <code class="highlighter-rouge">body</code>. The <code class="highlighter-rouge">field</code> helper is good for fields that call methods with the same name. Using <code class="highlighter-rouge">!</code> defines fields as non-null.</p>

<p>However, the post type isn’t accessible yet because it’s not attached to a query root.</p>

<h2 id="making-a-query-root">Making a query root</h2>

<p>A query root is “just” a type. Its fields don’t call methods on some object, though – instead, they retrieve objects which will be read.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">QueryRoot</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">ObjectType</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="nb">name</span> <span class="s2">"Query"</span>
  <span class="n">description</span> <span class="s2">"The query root for this schema"</span>

  <span class="n">field</span> <span class="ss">:post</span> <span class="k">do</span>
    <span class="n">type</span> <span class="no">PostType</span>
    <span class="n">description</span> <span class="s2">"Find a Post by id"</span>
    <span class="n">argument</span> <span class="ss">:id</span><span class="p">,</span> <span class="o">!</span><span class="n">types</span><span class="o">.</span><span class="no">ID</span>
    <span class="n">resolve</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
      <span class="no">Post</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s2">"id"</span><span class="p">])</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The query root has one field, <code class="highlighter-rouge">post</code>,  which finds a <code class="highlighter-rouge">Post</code> by ID. The <code class="highlighter-rouge">resolve</code> proc will be called with:</p>

<ul>
  <li><code class="highlighter-rouge">object</code>: The “parent” of this field (in the above case, it’s the query root, not very useful)</li>
  <li><code class="highlighter-rouge">arguments</code>: A hash with arguments passed to the field (keys will be strings)</li>
  <li><code class="highlighter-rouge">context</code>: An arbitrary object defined when running the query (see <a href="http://www.rubydoc.info/github/rmosolgo/graphql-ruby/file/guides/executing_queries.md">Executing queries</a>)</li>
</ul>

<h2 id="creating-a-schema">Creating a Schema</h2>

<p>Lastly, create the schema:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">Schema</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">query</span> <span class="no">QueryRoot</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This schema could handle queries like:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="err">firstPost:</span><span class="w"> </span><span class="err">post(id:</span><span class="w"> </span><span class="err">1)</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="err">title,</span><span class="w"> </span><span class="err">body</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="err">nextPost:</span><span class="w">  </span><span class="err">post(id:</span><span class="w"> </span><span class="mi">2</span><span class="err">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">title,</span><span class="w"> </span><span class="err">body</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="err">}</span><span class="w">
</span></code></pre>
</div>

<h2 id="complex-types">Complex Types</h2>

<p>Given a <code class="highlighter-rouge">Comment</code> model like this one, let’s add it to our schema:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Comment</span>
  <span class="kp">attr_accessor</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">:post_id</span>
  <span class="k">def</span> <span class="nf">post</span>
    <span class="c1"># find this comment's post</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>First, a <code class="highlighter-rouge">CommentType</code> to expose comments:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">CommentType</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">ObjectType</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="nb">name</span> <span class="s2">"Comment"</span>
  <span class="n">description</span> <span class="s2">"A reply to a post"</span>

  <span class="n">field</span> <span class="ss">:id</span><span class="p">,</span> <span class="o">!</span><span class="n">types</span><span class="o">.</span><span class="no">ID</span><span class="p">,</span> <span class="s2">"The unique ID of this comment"</span>
  <span class="n">field</span> <span class="ss">:body</span><span class="p">,</span> <span class="o">!</span><span class="n">types</span><span class="o">.</span><span class="no">String</span><span class="p">,</span> <span class="s2">"The content of this comment"</span>
  <span class="n">field</span> <span class="ss">:post</span><span class="p">,</span> <span class="o">!</span><span class="no">PostType</span><span class="p">,</span> <span class="s2">"The post this comment replies to"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Notice that the <code class="highlighter-rouge">post</code> field has <code class="highlighter-rouge">type: !PostType</code>. This means it returns a non-null <code class="highlighter-rouge">PostType</code> (which we defined above).</p>

<p>We should also add a <code class="highlighter-rouge">comments</code> field to <code class="highlighter-rouge">PostType</code>:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">PostType</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">ObjectType</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">field</span><span class="o">|</span>
  <span class="c1"># ... existing code ...</span>
  <span class="n">field</span> <span class="ss">:comments</span><span class="p">,</span> <span class="o">!</span><span class="n">types</span><span class="p">[</span><span class="o">!</span><span class="no">CommentType</span><span class="p">],</span> <span class="s2">"Responses to this post"</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">types[SomeType]</code> means that this field returns a <em>list</em> of <code class="highlighter-rouge">SomeType</code>.</p>

<h2 id="executing-a-query">Executing a Query</h2>

<p>After defining your schema, you can evaluate queries with <code class="highlighter-rouge">GraphQL::Query</code>. For example:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">Schema</span> <span class="o">=</span> <span class="no">GraphQL</span><span class="o">::</span><span class="no">Schema</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">query</span> <span class="no">QueryRoot</span> <span class="c1"># QueryRoot defined above</span>
<span class="k">end</span>

<span class="n">query_string</span> <span class="o">=</span> <span class="s2">"query getPost { post(id: 1) { id, title, comments { body } } }"</span>

<span class="n">result_hash</span> <span class="o">=</span> <span class="no">Schema</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
<span class="c1"># {</span>
<span class="c1">#   "post" : {</span>
<span class="c1">#     "id" : 1,</span>
<span class="c1">#     "title" : "GraphQL is cool",</span>
<span class="c1">#     "comments" : [</span>
<span class="c1">#       { "body" : "Yep, sure is."},</span>
<span class="c1">#       { "body" : "Still gotta figure out that reducing executor though"}</span>
<span class="c1">#     ]</span>
<span class="c1">#   }</span>
<span class="c1"># }</span>
</code></pre>
</div>

<h2 id="more-info">More Info</h2>

<p>Read more in some other guides:</p>

<ul>
  <li><a href="http://www.rubydoc.info/github/rmosolgo/graphql-ruby/file/guides/defining_your_schema.md">Defining Your Schema</a></li>
  <li><a href="http://www.rubydoc.info/github/rmosolgo/graphql-ruby/file/guides/executing_queries.md">Executing Queries</a></li>
</ul>
